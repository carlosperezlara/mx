#include "mxGeometry.h"

mxGeometry::mxGeometry() :
  fLastIdx(-1),
  fLyrIdx(-1),
  fX(0),
  fY(0),
  fZ(0),
  fSiW_a0(0.186),
  fSiW_a1(1.490)
{
  float mx[96] = {2.85688, -3.45312, -3.45312, -9.76313, -6.60812, -12.91810, 9.21687, 2.85688, 9.21687, 15.53690, 12.38190, 18.69190, -2.91687, 3.44313, 3.44313, 9.76313,
                  6.60812, 12.91810, -9.22687, -2.91687, -9.22687, -15.53690, -12.38190, -18.69190, -0.77500, -7.08500, -7.08500, -13.39500, -10.24000, -16.55000, 5.58500, -0.77500,
                  5.58500, 11.90500, 8.75000, 15.06000, 0.71500, 7.07500, 7.07500, 13.39500, 10.24000, 16.55000, -5.59500, 0.71500, -5.59500, -11.90500, -8.75000, -15.06000,
                  -2.85688, 3.45312, 3.45312, 9.76313, 6.60812, 12.91810, -9.21687, -2.85688, -9.21687, -15.53690, -12.38190, -18.69190, 2.91687, -3.44313, -3.44313, -9.76313,
                  -6.60812, -12.91810, 9.22687, 2.91687, 9.22687, 15.53690, 12.38190, 18.69190, 0.77500, 7.08500, 7.08500, 13.39500, 10.24000, 16.55000, -5.58500, 0.77500,
                  -5.58500, -11.90500, -8.75000, -15.06000, -0.71500, -7.07500, -7.07500, -13.39500, -10.24000, -16.55000, 5.59500, -0.71500, 5.59500, 11.90500, 8.75000, 15.06000 };
  for(int i=0; i!=96; ++i) fSiW_RX[i] = mx[i];
  float my[96] = {16.47000, 16.47000, 10.16000, 10.16000, 3.85000, 3.85000, 16.47000, 10.16000, 10.16000, 10.16000, 3.85000, 3.85000, -16.57000, -16.57000, -10.26000, -10.26000,
                  -3.95000, -3.95000, -16.57000, -10.26000, -10.26000, -10.26000, -3.95000, -3.95000, 18.61190, 18.61190, 12.30190, 12.30190, 5.99188, 5.99188, 18.61190, 12.30190,
                  12.30190, 12.30190, 5.99188, 5.99188, -18.71190, -18.71190, -12.40190, -12.40190, -6.09187, -6.09187, -18.71190, -12.40190, -12.40190, -12.40190, -6.09187, -6.09187,
                  16.47000, 16.47000, 10.16000, 10.16000, 3.85000, 3.85000, 16.47000, 10.16000, 10.16000, 10.16000, 3.85000, 3.85000, -16.57000, -16.57000, -10.26000, -10.26000,
                  -3.95000, -3.95000, -16.57000, -10.26000, -10.26000, -10.26000, -3.95000, -3.95000, 18.61190, 18.61190, 12.30190, 12.30190, 5.99188, 5.99188, 18.61190, 12.30190,
                  12.30190, 12.30190, 5.99188, 5.99188, -18.71190, -18.71190, -12.40190, -12.40190, -6.09187, -6.09187, -18.71190, -12.40190, -12.40190, -12.40190, -6.09187, -6.09187};
  for(int i=0; i!=96; ++i) fSiW_RY[i] = my[i];
  float mz[16] = {-203.982, -204.636, -205.29, -205.944, -206.598, -207.252, -207.906, -208.560,
		  +203.982, +204.636, +205.29, +205.944, +206.598, +207.252, +207.906, +208.560};
  for(int i=0; i!=16; ++i) fSiW_RZ[i] = mz[i];
  int lyrno[16] = { 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3 };
  for(int i=0; i!=16; ++i) fSiW_LyrNbr[i] = lyrno[i];
  int dly[4] = {0,1,-1,-2};
  for(int i=0; i!=4; ++i) fSiW_DLY[i] = dly[i];
}
//========
float mxGeometry::Reference(int k, int r) {
  if(k!=fLastIdx) UpdateVars(k);
  if(r==0) return fX;
  if(r==1) return fY;
  if(r==2) return fZ;
  if(r==3) return fLyrIdx;
  return -1;
}
//========
void mxGeometry::UpdateVars(int k) {
  // first 49152 correspond to key for SiW
  // next NNNN correspond to chn for PbSc
  if(k<49152) UpdateSiW(k);
  else UpdatePbSc(k-49152);
}
//========
void mxGeometry::UpdateSiW(int k) {
  int arm = k/24576;
  int pkt = (k/3072)%8;
  int sen = (k%3072)/128;
  int lyr = fSiW_LyrNbr[ 2*pkt + (sen/12) ];
  int senlyr = sen%12;
  int sgnTB = 1;
  int sgnAR = 1;
  if(pkt>3) {
    senlyr += 12;
    sgnTB = -1;
  }
  if(arm>0) sgnAR = -1;
  int typ = lyr % 2;
  int ref = arm*48 + typ*24 + senlyr;
  float x = fSiW_RX[ref];
  float y = fSiW_RY[ref];
  float nx = fSiW_RX[ref]/ (typ==0?fSiW_a0:fSiW_a1);
  float ny = fSiW_RY[ref]/ (typ==0?fSiW_a1:fSiW_a0);
  if(typ==0) {
    x -= sgnAR*sgnTB*((k%128)/4)*(fSiW_a0+0.008);
    y += sgnTB*fSiW_DLY[k%4]*(fSiW_a1+0.008);
    nx -= sgnAR*sgnTB*((k%128)/4);
    ny += sgnTB*fSiW_DLY[k%4];
  } else {
    y -= sgnTB*((k%128)/4)*(fSiW_a0+0.008);
    x -= sgnAR*sgnTB*fSiW_DLY[k%4]*(fSiW_a1+0.008);
    ny -= sgnTB*((k%128)/4);
    nx -= sgnAR*sgnTB*fSiW_DLY[k%4];
  }
  fX = x;
  fY = y;
  fZ = fSiW_RZ[arm*8+lyr];
  fLyrIdx = arm*9+lyr;
  fLastIdx = k;
}
//========
void mxGeometry::UpdatePbSc(int k) {
}
